<?xml version="1.1" encoding="UTF-8" standalone="no" ?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog db/changelog/xsd/dbchangelog-4.4.xsd"
        context="schema-change">

    <changeSet id="14-Add_unique_index_on_orcid" context="schema-change" author="keyuk jon">
        <sql>
            CREATE OR REPLACE FUNCTION get_identifier_uri(data jsonb, idName text)
            RETURNS TEXT AS
            '
            declare
                ele jsonb;
                type text;
            BEGIN
                for ele in select * from jsonb_array_elements(data)
                loop
                    type := ele->>''type'';
                    if lower(type) = idName then
                        RETURN ele->>''uri'';
                    END if;
                end loop;
                RETURN null;
            END
            '
            LANGUAGE plpgsql IMMUTABLE;

            CREATE OR REPLACE FUNCTION get_orcid_id(data jsonb)
            RETURNS TEXT AS
            '
            BEGIN
                RETURN get_identifier_uri(data, ''orcid'');
            END
            '
            LANGUAGE plpgsql IMMUTABLE;

            CREATE OR REPLACE FUNCTION get_wikidata_id(data jsonb)
            RETURNS TEXT AS
            '
            BEGIN
                RETURN get_identifier_uri(data, ''wikidata'');
            END
            '
            LANGUAGE plpgsql IMMUTABLE;

            CREATE UNIQUE INDEX person_unique_identifier_orcid
            ON person (lower(get_orcid_id(identifiers))) where get_orcid_id(identifiers) is not null;

            CREATE UNIQUE INDEX person_unique_identifier_wikidata
            ON person (lower(get_wikidata_id(identifiers))) where get_wikidata_id(identifiers) is not null;
        </sql>
    </changeSet>

</databaseChangeLog>
